<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparateur d'Assurance Vie</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Base & Réinitialisation */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f7f9fc;
      color: #333;
      line-height: 1.6;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    /* Header moderne */
    .header {
      background: linear-gradient(135deg, #4a90e2, #357ab8);
      color: #fff;
      padding: 30px 0;
      text-align: center;
      font-size: 2.2em;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    /* Sous-header */
    .sub-header {
      text-align: center;
      font-size: 0.9em;
      color: #666;
      margin-bottom: 20px;
    }
    /* Conteneur principal */
    .container {
      max-width: 1200px;
      margin: 0 auto 40px;
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    /* Footer */
    .footer {
      text-align: center;
      font-size: 0.9em;
      color: #666;
      margin-top: 40px;
      padding: 10px 0;
      border-top: 1px solid #e2e8f0;
    }
    /* Zone des filtres */
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    .filters > div {
      margin: 5px;
    }
    .filters label {
      font-weight: 500;
      margin-right: 5px;
    }
    .filters select,
    .filters input[type="text"],
    .filters input[type="range"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    .filters input[type="text"]:focus,
    .filters select:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 5px rgba(74,144,226,0.3);
    }
    .filters input[type="range"] {
      cursor: pointer;
    }
    /* Bouton toggle (flèche) */
    .toggle-arrow {
      background: none;
      border: none;
      font-size: 1em;
      cursor: pointer;
      margin-right: 5px;
    }
    /* Info-icons avec tooltip */
    .info-icon {
      position: relative;
      display: inline-block;
      cursor: help;
      margin-left: 5px;
      color: #4a90e2;
      font-size: 1em;
    }
    .info-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 5px 8px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 100;
    }
    .info-icon:hover::after {
      opacity: 1;
    }
    /* Cases à cocher */
    .filters input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 5px;
      cursor: pointer;
    }
    /* Tableau principal avec alternance de couleur */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table thead {
      background-color: #f0f4f8;
    }
    table th, table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    table tbody tr:hover {
      background-color: #f9fafb;
    }
    /* Renommage de la colonne Actions en Performances */
    table thead th:last-child {
      text-align: center;
    }
    /* Boutons d'action */
    .btn-performance {
      background-color: #4a90e2;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }
    .btn-performance:hover {
      background-color: #357ab8;
    }
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: center;
      }
      table th, table td {
        padding: 10px;
      }
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      padding: 20px;
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 95%;
      max-width: 900px;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5em;
      cursor: pointer;
      color: #888;
    }
    .profile-section {
      margin-bottom: 40px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 20px;
    }
    .profile-section:last-child {
      border-bottom: none;
    }
    .charts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .charts canvas {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 10px;
    }
    /* Tableau de performances */
    .perf-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }
    .perf-table th,
    .perf-table td {
      border: 1px solid #e2e8f0;
      padding: 6px 8px;
      text-align: center;
      font-size: 0.9em;
    }
    .perf-table th {
      background-color: #f0f4f8;
    }
    /* Section extra (dépliable) – disposition en deux colonnes */
    .extra-container {
      display: flex;
      justify-content: space-between;
    }
    .extra-left {
      width: 55%;
      text-align: left;
    }
    .extra-right {
      width: 40%;
      text-align: left;
    }
    .extra-info {
      background-color: #f9fafb;
    }
    /* Encart pour supports d'investissement en gestion libre */
    .investment-supports {
      margin-top: 10px;
      text-align: left;
    }
    .investment-supports h4 {
      margin-bottom: 5px;
      font-size: 1em;
      color: #357ab8;
    }
    .investment-supports p {
      margin: 2px 0;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">Comparateur d'Assurance Vie</div>
  <!-- Sous-header -->
  <div class="sub-header">
    <p>&copy; Baptiste Plat Garnier</p>
  </div>
  <div class="container">
    <!-- Zone des filtres -->
    <div class="filters">
      <div>
        <label for="assureur">Assureur :</label>
        <select id="assureur">
          <option value="">Tous</option>
        </select>
      </div>
      <div>
        <label for="distributeur">Distributeur :</label>
        <select id="distributeur">
          <option value="">Tous</option>
        </select>
      </div>
      <div>
        <label for="nom">Nom du contrat :</label>
        <input type="text" id="nom" placeholder="Rechercher un contrat">
      </div>
      <div>
        <label for="versement">Versement initial (max) :</label>
        <input type="range" id="versement" value="10000" min="0" max="10000" step="100">
        <span id="versementValue">10000</span>
      </div>
      <!-- Cases à cocher avec info-icons -->
      <div>
        <input type="checkbox" id="gestion" class="checkbox-filter" data-column="Gestion pilotée" data-value="Gestion pilotée">
        <label for="gestion">Gestion pilotée</label>
        <span class="info-icon" data-tooltip="Ce contrat offre une gestion pilotée par des experts.">ℹ</span>
      </div>
      <div>
        <input type="checkbox" id="versements_programmes" class="checkbox-filter" data-column="Versements programmés" data-value="Versements programmés">
        <label for="versements_programmes">Versements programmés</label>
        <span class="info-icon" data-tooltip="Ce contrat permet des versements programmés réguliers.">ℹ</span>
      </div>
      <div>
        <input type="checkbox" id="securisation" class="checkbox-filter" data-column="Sécurisation des plus-values" data-value="Sécurisation des plus-values">
        <label for="securisation">Sécurisation des plus-values</label>
        <span class="info-icon" data-tooltip="Ce contrat offre une sécurisation optimisée de vos plus-values.">ℹ</span>
      </div>
      <div>
        <input type="checkbox" id="dynamisation" class="checkbox-filter" data-column="Dynamisation des plus-values" data-value="Dynamisation des plus-values">
        <label for="dynamisation">Dynamisation des plus-values</label>
        <span class="info-icon" data-tooltip="Ce contrat permet une dynamisation active de vos plus-values.">ℹ</span>
      </div>
      <div>
        <input type="checkbox" id="investissement" class="checkbox-filter" data-column="Investissement progressif" data-value="Investissement progressif">
        <label for="investissement">Investissement progressif</label>
        <span class="info-icon" data-tooltip="Ce contrat propose un investissement progressif adapté.">ℹ</span>
      </div>
      <div>
        <input type="checkbox" id="stoploss" class="checkbox-filter" data-column="Stop/Loss" data-value="Stop/Loss">
        <label for="stoploss">Stop/Loss</label>
        <span class="info-icon" data-tooltip="Ce contrat inclut un mécanisme de stop/loss pour limiter les pertes.">ℹ</span>
      </div>
      <div>
        <input type="checkbox" id="reequilibrage" class="checkbox-filter" data-column="Réequilibrage auitomatique" data-value="Réequilibrage auitomatique">
        <label for="reequilibrage">Réequilibrage auitomatique</label>
        <span class="info-icon" data-tooltip="Ce contrat offre un rééquilibrage automatique de votre portefeuille.">ℹ</span>
      </div>
    </div>

    <!-- Tableau principal -->
    <table id="contrats">
      <thead>
        <tr>
          <th data-key="nom">Nom du contrat</th>
          <th data-key="assureur">Assureur</th>
          <th data-key="distributeur">Distributeur</th>
          <th data-key="versement">Versement initial</th>
          <th>Performances</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les données se chargeront ici -->
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; Baptiste Plat Garnier</p>
  </footer>

  <!-- Modal de performance -->
  <div id="performanceModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <h2 id="modalTitle">Performances de la gestion pilotée</h2>
      <div id="profileChartsContainer"></div>
    </div>
  </div>

  <!-- Inclusion de PapaParse et Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Fonction pour construire les tableaux financiers décomposés
    function buildFinancialTables(item) {
      let tableFraisFixes = `<h4>Frais fixes</h4>
        <table class="perf-table">
          <thead>
            <tr>
              <th>Frais de dossier</th>
              <th>Droits d'entrée</th>
              <th>Frais de rachat</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${item["Frais de dossier"] || "-"}</td>
              <td>${item["Droits d'entrée"] || "-"}</td>
              <td>${item["Frais de rachat"] || "-"}</td>
            </tr>
          </tbody>
        </table>`;
      let tableFraisRecurrents = `<h4>Frais récurrents</h4>
        <table class="perf-table">
          <thead>
            <tr>
              <th>FV€</th>
              <th>FVUC</th>
              <th>FVGSM</th>
              <th>Arbitrages gratuits/an</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${item["FV€"] || "-"}</td>
              <td>${item["FVUC"] || "-"}</td>
              <td>${item["FVGSM"] || "-"}</td>
              <td>${item["Arbitrages gratuits/an"] || "-"}</td>
            </tr>
          </tbody>
        </table>`;
      let tableFraisGestion = `<h4>Frais de gestion</h4>
        <table class="perf-table">
          <thead>
            <tr>
              <th>Fonds en euro classique</th>
              <th>Frais de gestion UC</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${item["Fonds en euro classique"] || "-"}</td>
              <td>${item["Frais de gestion UC"] || "-"}</td>
            </tr>
          </tbody>
        </table>`;
      return tableFraisFixes + tableFraisRecurrents + tableFraisGestion;
    }

    // Fonction pour afficher les données dans le tableau principal et la section dépliable
    function afficherDonnees(donnees) {
      const tbody = document.querySelector("#contrats tbody");
      tbody.innerHTML = "";
      donnees.forEach((item, index) => {
        // Ligne principale
        const tr = document.createElement("tr");
        tr.style.backgroundColor = (index % 2 === 0) ? "#fff" : "#EFEFEF";
        tr.innerHTML = `
          <td>
            <button class="toggle-arrow" onclick="toggleExtra(${index}, this)">▼</button>
            ${item.nom}
          </td>
          <td>${item.assureur}</td>
          <td>${item.distributeur}</td>
          <td>${item.versement}</td>
          <td>${
            (item["Gestion pilotée"] && item["Gestion pilotée"].toLowerCase().trim() === "gestion pilotée")
              ? `<button class="btn-performance" onclick='viewPerformance(${JSON.stringify(item)})'>Accéder aux performances</button>`
              : ''
          }</td>
        `;
        tbody.appendChild(tr);
        // Ligne dépliable avec deux colonnes
        const extraRow = document.createElement("tr");
        extraRow.id = "extra_" + index;
        extraRow.className = "extra-info";
        extraRow.style.display = "none";
        extraRow.innerHTML = `<td colspan="5">
          <div class="extra-container">
            <div class="extra-left">
              <p><strong>Année de lancement :</strong> ${item.annee}</p>
              <p><strong>Type de contrat :</strong> ${item["Type de contrat"] || "-"}</p>
              <p><strong>Nature du contrat :</strong> ${item.nature}</p>
              <p><strong>Encours min. en gestion pilotée :</strong> ${item.ticket}</p>
              <p><strong>Architecture :</strong> ${item.architecture}</p>
              <p><strong>Frais additionnels de la gestion pilotée :</strong> ${item["frais add. GP"]}</p>
              <h4>Supports d'investissement en gestion libre</h4>
              <p><strong>ETF :</strong> ${item["ETF"] || "-"}</p>
              <p><strong>Titres vifs :</strong> ${item["Titres vifs"] || "-"}</p>
              <p><strong>FCPR :</strong> ${item["FCPR"] || "-"}</p>
              <p><strong>OPCI :</strong> ${item["OPCI"] || "-"}</p>
              <p><strong>SCPI :</strong> ${item["SCPI"] || "-"}</p>
              <p><strong>SCI :</strong> ${item["SCI"] || "-"}</p>
            </div>
            <div class="extra-right">
              ${buildFinancialTables(item)}
            </div>
          </div>
        </td>`;
        tbody.appendChild(extraRow);
      });
    }

    // Fonction de bascule pour la ligne dépliable
    function toggleExtra(index, btn) {
      const extraRow = document.getElementById("extra_" + index);
      if (extraRow.style.display === "none" || extraRow.style.display === "") {
        extraRow.style.display = "table-row";
        btn.textContent = "▲";
      } else {
        extraRow.style.display = "none";
        btn.textContent = "▼";
      }
    }

    // Fonctions pour remplir les menus déroulants classiques
    function remplirFiltreAssureur(donnees) {
      const select = document.getElementById("assureur");
      select.innerHTML = '<option value="">Tous</option>';
      const assureurs = [...new Set(donnees.map(item => item.assureur))];
      assureurs.forEach(assureur => {
        const option = document.createElement("option");
        option.value = assureur;
        option.textContent = assureur;
        select.appendChild(option);
      });
    }
    function remplirFiltreDistributeur(donnees) {
      const select = document.getElementById("distributeur");
      select.innerHTML = '<option value="">Tous</option>';
      const distributeurs = [...new Set(donnees.map(item => item.distributeur))];
      distributeurs.forEach(distributeur => {
        const option = document.createElement("option");
        option.value = distributeur;
        option.textContent = distributeur;
        select.appendChild(option);
      });
    }

    // Fonction de filtrage combiné
    function filtrerDonnees(donnees) {
      const filtreAssureur = document.getElementById("assureur").value;
      const filtreDistributeur = document.getElementById("distributeur").value;
      const filtreNom = document.getElementById("nom").value.toLowerCase();
      const maxVersement = parseFloat(document.getElementById("versement").value);
      const checkboxes = document.querySelectorAll(".checkbox-filter");
      const donneesFiltrees = donnees.filter(item => {
        let versement = parseFloat(item.versement.replace(/[^\d.]/g, '')) || 0;
        let conditionsCheckbox = true;
        checkboxes.forEach(cb => {
          if (cb.checked) {
            const col = cb.dataset.column;
            const val = cb.dataset.value;
            conditionsCheckbox = conditionsCheckbox && (item[col] && item[col].toLowerCase().trim() === val.toLowerCase().trim());
          }
        });
        return (
          (filtreAssureur === "" || item.assureur === filtreAssureur) &&
          (filtreDistributeur === "" || item.distributeur === filtreDistributeur) &&
          (filtreNom === "" || item.nom.toLowerCase().includes(filtreNom)) &&
          (isNaN(maxVersement) || versement <= maxVersement) &&
          conditionsCheckbox
        );
      });
      afficherDonnees(donneesFiltrees);
    }

    // Fonction de performance (corrigée)
    function viewPerformance(contract) {
      const modal = document.getElementById("performanceModal");
      modal.style.display = "block";
      document.getElementById("modalTitle").textContent = `Performances de ${contract.nom}`;
      const chartsContainer = document.getElementById("profileChartsContainer");
      chartsContainer.innerHTML = "";
      const performanceCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTN6FYOsXyedk2KNxaqBAUz4ctA_fUPeT7dr3Ki4-uks2FUg2D9TqseBYT9u05sA_LCbR47rJbkNWGI/pub?output=csv&gid=1183800682&single=true';
      Papa.parse(performanceCsvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          const perfData = results.data;
          // Comparaison avec .trim() pour éliminer d'éventuels espaces
          const contractPerfRows = perfData.filter(row =>
            row["Nom du contrat"] && row["Nom du contrat"].trim() === contract.nom.trim()
          );
          if (contractPerfRows.length === 0) {
            chartsContainer.innerHTML = "<p>Aucune donnée de performance trouvée pour ce contrat.</p>";
            return;
          }
          contractPerfRows.forEach((profileRow, index) => {
            const profileDiv = document.createElement("div");
            profileDiv.className = "profile-section";
            profileDiv.innerHTML = `<h3>Profil : ${profileRow["Profil"] || "Non défini"} - Gestionnaire : ${profileRow["Gestionnaire d'actif"] || "Non défini"}</h3>`;
            const pieCanvas = document.createElement("canvas");
            pieCanvas.id = `pieChart_${index}`;
            pieCanvas.width = 200;
            pieCanvas.height = 200;
            const chartsDiv = document.createElement("div");
            chartsDiv.className = "charts";
            chartsDiv.appendChild(pieCanvas);
            profileDiv.appendChild(chartsDiv);
            const partUC = profileRow.part_uc ? parseFloat(profileRow.part_uc) : 50;
            const partFonds = profileRow.part_fonds ? parseFloat(profileRow.part_fonds) : (100 - partUC);
            new Chart(pieCanvas.getContext("2d"), {
              type: 'pie',
              data: {
                labels: ['UC', 'Fonds en euros'],
                datasets: [{
                  data: [partUC, partFonds],
                  backgroundColor: ['#36A2EB', '#FFCE56']
                }]
              },
              options: { responsive: true }
            });
            const yearsArray = ["2024", "2023", "2022", "2021", "2020", "2019", "2018", "2021", "2017", "2016"];
            let tableHTML = `<table class="perf-table"><thead><tr><th>Année</th><th>Performance (%)</th></tr></thead><tbody>`;
            yearsArray.forEach(year => {
              const perfValue = (profileRow[year] !== undefined && profileRow[year] !== "") ? profileRow[year] : "-";
              tableHTML += `<tr><td>${year}</td><td>${perfValue}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            profileDiv.innerHTML += tableHTML;
            chartsContainer.appendChild(profileDiv);
          });
        },
        error: function(err) {
          console.error("Erreur lors du chargement du CSV de performance :", err);
        }
      });
    }

    // Initialisation du comparateur principal
    function init() {
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTN6FYOsXyedk2KNxaqBAUz4ctA_fUPeT7dr3Ki4-uks2FUg2D9TqseBYT9u05sA_LCbR47rJbkNWGI/pub?output=csv';
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          const data = results.data;
          window.globalData = data;
          afficherDonnees(data);
          remplirFiltreAssureur(data);
          remplirFiltreDistributeur(data);
          const slider = document.getElementById("versement");
          slider.min = 0;
          slider.max = 10000;
          slider.value = 10000;
          document.getElementById("versementValue").textContent = 10000;
          document.getElementById("nom").addEventListener("input", () => filtrerDonnees(data));
          document.getElementById("versement").addEventListener("input", function() {
            document.getElementById("versementValue").textContent = this.value;
            filtrerDonnees(data);
          });
          const checkboxFilters = document.querySelectorAll(".checkbox-filter");
          checkboxFilters.forEach(cb => cb.addEventListener("change", () => filtrerDonnees(data)));
        },
        error: function(err) {
          console.error("Erreur lors du chargement du CSV :", err);
        }
      });
    }
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
