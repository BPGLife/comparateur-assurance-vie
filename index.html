<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparateur d'Assurance Vie</title>
  <style>
    /* Réinitialisation et styles de base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f2f4f8;
      color: #333;
      line-height: 1.6;
    }
    .header {
      background-color: #2b6cb0;
      color: #fff;
      padding: 20px 0;
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }
    .filters > div { margin: 5px; }
    .filters label {
      font-size: 1em;
      margin-right: 5px;
    }
    .filters select,
    .filters input[type="text"],
    .filters input[type="range"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    /* Style pour les cases à cocher */
    .filters input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table thead { background-color: #f0f0f0; }
    table th, table td {
      padding: 12px 15px;
      text-align: left;
    }
    table th { cursor: pointer; }
    table tbody tr {
      border-bottom: 1px solid #eee;
      transition: background-color 0.3s;
    }
    table tbody tr:hover { background-color: #f9f9f9; }
    /* Style pour le bouton d'action */
    .btn-performance {
      background-color: #2b6cb0;
      color: #fff;
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .btn-performance:hover {
      background-color: #234a7d;
    }
    @media (max-width: 768px) {
      .filters { flex-direction: column; align-items: center; }
      table th, table td { padding: 10px; }
    }
    /* Styles pour le modal */
    .modal {
      display: none; /* caché par défaut */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 95%;
      max-width: 900px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5em;
      cursor: pointer;
      color: #888;
    }
    .profile-section {
      margin-bottom: 40px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 20px;
    }
    .profile-section:last-child {
      border-bottom: none;
    }
    .charts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-around;
    }
    .charts canvas {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
    }
    /* Styles pour le tableau de performances */
    .perf-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 400px;
      margin-top: 10px;
    }
    .perf-table th, .perf-table td {
      border: 1px solid #ddd;
      padding: 5px;
      text-align: center;
    }
    .perf-table th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div class="header">Comparateur d'Assurance Vie</div>
  <div class="container">
    <!-- Section des filtres -->
    <div class="filters">
      <!-- Filtre pour l'assureur -->
      <div>
        <label for="assureur">Assureur :</label>
        <select id="assureur">
          <option value="">Tous</option>
        </select>
      </div>
      <!-- Filtre pour le distributeur -->
      <div>
        <label for="distributeur">Distributeur :</label>
        <select id="distributeur">
          <option value="">Tous</option>
        </select>
      </div>
      <!-- Recherche sur le nom du contrat -->
      <div>
        <label for="nom">Nom du contrat :</label>
        <input type="text" id="nom" placeholder="Rechercher un contrat">
      </div>
      <!-- Curseur sur le versement initial -->
      <div>
        <label for="versement">Versement initial (max) :</label>
        <input type="range" id="versement" value="0" step="100">
        <span id="versementValue"></span>
      </div>
      <!-- Cases à cocher pour les colonnes supplémentaires -->
      <div>
        <input type="checkbox" id="gestion" class="checkbox-filter" data-column="Gestion pilotée" data-value="Gestion pilotée">
        <label for="gestion">Gestion pilotée</label>
      </div>
      <div>
        <input type="checkbox" id="versements_programmes" class="checkbox-filter" data-column="Versements programmés" data-value="Versements programmés">
        <label for="versements_programmes">Versements programmés</label>
      </div>
      <div>
        <input type="checkbox" id="securisation" class="checkbox-filter" data-column="Sécurisation des plus-values" data-value="Sécurisation des plus-values">
        <label for="securisation">Sécurisation des plus-values</label>
      </div>
      <div>
        <input type="checkbox" id="dynamisation" class="checkbox-filter" data-column="Dynamisation des plus-values" data-value="Dynamisation des plus-values">
        <label for="dynamisation">Dynamisation des plus-values</label>
      </div>
      <div>
        <input type="checkbox" id="investissement" class="checkbox-filter" data-column="Investissement progressif" data-value="Investissement progressif">
        <label for="investissement">Investissement progressif</label>
      </div>
      <div>
        <input type="checkbox" id="stoploss" class="checkbox-filter" data-column="Stop/Loss" data-value="Stop/Loss">
        <label for="stoploss">Stop/Loss</label>
      </div>
      <div>
        <input type="checkbox" id="reequilibrage" class="checkbox-filter" data-column="Réequilibrage auitomatique" data-value="Réequilibrage auitomatique">
        <label for="reequilibrage">Réequilibrage auitomatique</label>
      </div>
    </div>

    <!-- Tableau d'affichage (colonnes principales) -->
    <table id="contrats">
      <thead>
        <tr>
          <th data-key="nom">Nom du contrat</th>
          <th data-key="annee">Année</th>
          <th data-key="assureur">Assureur</th>
          <th data-key="distributeur">Distributeur</th>
          <th data-key="nature">Nature</th>
          <th data-key="versement">Versement initial</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les données seront insérées ici -->
      </tbody>
    </table>
  </div>

  <!-- Modal pour le focus performance -->
  <div id="performanceModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <h2 id="modalTitle">Performances de la gestion pilotée</h2>
      <!-- Container pour les sections de profils -->
      <div id="profileChartsContainer"></div>
    </div>
  </div>

  <!-- Inclusion de PapaParse et Chart.js depuis CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Fonction pour afficher les données dans le tableau principal
    function afficherDonnees(donnees) {
      const tbody = document.querySelector("#contrats tbody");
      tbody.innerHTML = "";
      donnees.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.nom}</td>
          <td>${item.annee}</td>
          <td>${item.assureur}</td>
          <td>${item.distributeur}</td>
          <td>${item.nature}</td>
          <td>${item.versement}</td>
          <td>${
            (item["Gestion pilotée"] && item["Gestion pilotée"].toLowerCase().trim() === "gestion pilotée")
              ? `<button class="btn-performance" onclick='viewPerformance(${JSON.stringify(item)})'>Accéder aux performances de la gestion pilotée</button>`
              : ''
          }</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Remplit le menu déroulant pour les assureurs
    function remplirFiltreAssureur(donnees) {
      const select = document.getElementById("assureur");
      const assureurs = [...new Set(donnees.map(item => item.assureur))];
      assureurs.forEach(assureur => {
        const option = document.createElement("option");
        option.value = assureur;
        option.textContent = assureur;
        select.appendChild(option);
      });
    }

    // Remplit le menu déroulant pour les distributeurs
    function remplirFiltreDistributeur(donnees) {
      const select = document.getElementById("distributeur");
      const distributeurs = [...new Set(donnees.map(item => item.distributeur))];
      distributeurs.forEach(distributeur => {
        const option = document.createElement("option");
        option.value = distributeur;
        option.textContent = distributeur;
        select.appendChild(option);
      });
    }

    // Fonction de filtrage combiné pour tous les filtres
    function filtrerDonnees(donnees) {
      const filtreAssureur = document.getElementById("assureur").value;
      const filtreDistributeur = document.getElementById("distributeur").value;
      const filtreNom = document.getElementById("nom").value.toLowerCase();
      const maxVersement = parseFloat(document.getElementById("versement").value);
      const checkboxes = document.querySelectorAll(".checkbox-filter");

      const donneesFiltrees = donnees.filter(item => {
        // Nettoyage de la valeur de versement : on retire tout caractère non numérique (sauf le point)
        let versement = parseFloat(item.versement.replace(/[^\d.]/g, '')) || 0;
        let conditionsCheckbox = true;
        checkboxes.forEach(checkbox => {
          if (checkbox.checked) {
            const col = checkbox.dataset.column;
            const val = checkbox.dataset.value;
            conditionsCheckbox = conditionsCheckbox &&
              (item[col] && item[col].toLowerCase().trim() === val.toLowerCase().trim());
          }
        });
        return (
          (filtreAssureur === "" || item.assureur === filtreAssureur) &&
          (filtreDistributeur === "" || item.distributeur === filtreDistributeur) &&
          (filtreNom === "" || item.nom.toLowerCase().includes(filtreNom)) &&
          (isNaN(maxVersement) || versement <= maxVersement) &&
          conditionsCheckbox
        );
      });
      afficherDonnees(donneesFiltrees);
    }

    // Fonction pour ouvrir le modal et afficher les performances pour tous les profils du contrat
    function viewPerformance(contract) {
      // Ouvrir le modal
      const modal = document.getElementById("performanceModal");
      modal.style.display = "block";
      document.getElementById("modalTitle").textContent = `Performances de ${contract.nom}`;

      // Vider le container de profils
      const chartsContainer = document.getElementById("profileChartsContainer");
      chartsContainer.innerHTML = "";

      // URL du second onglet contenant les données de performance
      const performanceCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTN6FYOsXyedk2KNxaqBAUz4ctA_fUPeT7dr3Ki4-uks2FUg2D9TqseBYT9u05sA_LCbR47rJbkNWGI/pub?gid=1183800682&single=true&output=csv';

      Papa.parse(performanceCsvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          const perfData = results.data;
          // Filtrer les lignes correspondant au contrat (basé sur "Nom du contrat")
          const contractPerfRows = perfData.filter(row => row["Nom du contrat"] === contract.nom);

          if (contractPerfRows.length === 0) {
            chartsContainer.innerHTML = "<p>Aucune donnée de performance trouvée pour ce contrat.</p>";
            return;
          }

          // Pour chaque profil du contrat, créer une section avec ses graphiques et son tableau de performances
          contractPerfRows.forEach((profileRow, index) => {
            // Créer un container pour le profil et afficher le nom du profil et le gestionnaire d'actif
            const profileDiv = document.createElement("div");
            profileDiv.className = "profile-section";
            profileDiv.innerHTML = `<h3>Profil : ${profileRow["Profil"] || "Non défini"} - Gestionnaire : ${profileRow["Gestionnaire d'actif"] || "Non défini"}</h3>`;

            // Créer un canvas plus petit pour le camembert UC/Fonds (200x200)
            const pieCanvas = document.createElement("canvas");
            pieCanvas.id = `pieChart_${index}`;
            pieCanvas.width = 200;
            pieCanvas.height = 200;

            // Ajouter le canvas du camembert
            const chartsDiv = document.createElement("div");
            chartsDiv.className = "charts";
            chartsDiv.appendChild(pieCanvas);
            profileDiv.appendChild(chartsDiv);

            // Création du camembert via Chart.js
            const partUC = profileRow.part_uc ? parseFloat(profileRow.part_uc) : 50;
            const partFonds = profileRow.part_fonds ? parseFloat(profileRow.part_fonds) : (100 - partUC);
            new Chart(pieCanvas.getContext("2d"), {
              type: 'pie',
              data: {
                labels: ['UC', 'Fonds en euros'],
                datasets: [{
                  data: [partUC, partFonds],
                  backgroundColor: ['#36A2EB', '#FFCE56']
                }]
              },
              options: { responsive: true }
            });

            // Création d'un tableau pour afficher les performances annuelles
            // Années à afficher : 2024 à 2016
            const performanceYears = ["2024", "2023", "2022", "2021", "2020", "2019", "2020", "2018", "2017", "2016"];
            // Correction : ici, je vous propose d'utiliser exactement les années demandées (2024,2023,...,2016)
            const yearsToDisplay = ["2024", "2023", "2022", "2021", "2020", "2019", "2018", "2017", "2016"];
            let tableHTML = `<table class="perf-table"><thead><tr><th>Année</th><th>Performance (%)</th></tr></thead><tbody>`;
            yearsToDisplay.forEach(year => {
              const perfValue = (profileRow[year] !== undefined && profileRow[year] !== "") ? profileRow[year] : "-";
              tableHTML += `<tr><td>${year}</td><td>${perfValue}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            profileDiv.innerHTML += tableHTML;

            chartsContainer.appendChild(profileDiv);
          });
        },
        error: function(err) {
          console.error("Erreur lors du chargement du CSV de performance :", err);
        }
      });
    }

    // Gestion de la fermeture du modal
    document.getElementById("modalClose").addEventListener("click", function() {
      document.getElementById("performanceModal").style.display = "none";
    });
    // Fermer le modal si l'utilisateur clique en dehors du contenu
    window.addEventListener("click", function(event) {
      const modal = document.getElementById("performanceModal");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });

    // Fonction d'initialisation : chargement du CSV principal et configuration des filtres
    function init() {
      // URL du CSV du premier onglet (comparateur principal)
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTN6FYOsXyedk2KNxaqBAUz4ctA_fUPeT7dr3Ki4-uks2FUg2D9TqseBYT9u05sA_LCbR47rJbkNWGI/pub?output=csv';

      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          const data = results.data;
          console.log("Données chargées :", data);
          afficherDonnees(data);
          remplirFiltreAssureur(data);
          remplirFiltreDistributeur(data);

          // Définir la plage du curseur pour le versement initial
          const versements = data.map(item => parseFloat(item.versement.replace(/[^\d.]/g, '')) || 0);
          const minVersement = Math.min(...versements);
          const maxVersementData = Math.max(...versements);
          const slider = document.getElementById("versement");
          slider.min = minVersement;
          slider.max = maxVersementData;
          slider.value = maxVersementData; // Par défaut, afficher tous les contrats
          document.getElementById("versementValue").textContent = maxVersementData;

          // Écouteurs d'événements pour chaque filtre
          document.getElementById("assureur").addEventListener("change", () => filtrerDonnees(data));
          document.getElementById("distributeur").addEventListener("change", () => filtrerDonnees(data));
          document.getElementById("nom").addEventListener("input", () => filtrerDonnees(data));
          document.getElementById("versement").addEventListener("input", function() {
            document.getElementById("versementValue").textContent = this.value;
            filtrerDonnees(data);
          });
          const checkboxFilters = document.querySelectorAll(".checkbox-filter");
          checkboxFilters.forEach(checkbox => {
            checkbox.addEventListener("change", () => filtrerDonnees(data));
          });
        },
        error: function(err) {
          console.error("Erreur lors du chargement du CSV :", err);
        }
      });
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
