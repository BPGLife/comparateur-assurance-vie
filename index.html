<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comparateur d'Assurance Vie</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Base & Réinitialisation */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f7f9fc;
      color: #333;
      line-height: 1.6;
    }
    a {
      text-decoration: none;
      color: inherit;
    }
    /* Header moderne */
    .header {
      background: linear-gradient(135deg, #4a90e2, #357ab8);
      color: #fff;
      padding: 30px 0;
      text-align: center;
      font-size: 2.2em;
      font-weight: 700;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    /* Sous-header */
    .sub-header {
      text-align: center;
      font-size: 0.9em;
      color: #666;
      margin-bottom: 20px;
    }
    /* Conteneur principal */
    .container {
      max-width: 1200px;
      margin: 0 auto 40px;
      background-color: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    /* Footer */
    .footer {
      text-align: center;
      font-size: 0.9em;
      color: #666;
      margin-top: 40px;
      padding: 10px 0;
      border-top: 1px solid #e2e8f0;
    }
    /* Zone des filtres */
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    .filters > div {
      margin: 5px;
    }
    .filters label {
      font-weight: 500;
      margin-right: 5px;
    }
    .filters select,
    .filters input[type="text"],
    .filters input[type="range"],
    .filters input[type="number"] {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    .filters input[type="text"]:focus,
    .filters select:focus {
      outline: none;
      border-color: #4a90e2;
      box-shadow: 0 0 5px rgba(74,144,226,0.3);
    }
    .filters input[type="range"] {
      cursor: pointer;
    }
    /* Bouton toggle (flèche) */
    .toggle-arrow {
      background: none;
      border: none;
      font-size: 1em;
      cursor: pointer;
      margin-right: 5px;
    }
    /* Info-icons avec tooltip */
    .info-icon {
      position: relative;
      display: inline-block;
      cursor: help;
      margin-left: 5px;
      color: #4a90e2;
      font-size: 1em;
    }
    .info-icon::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 5px 8px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 100;
    }
    .info-icon:hover::after {
      opacity: 1;
    }
    /* Cases à cocher */
    .filters input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 5px;
      cursor: pointer;
    }
    /* Groupe de checkbox */
    .checkbox-group {
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 6px;
      background: #f0f4f8;
    }
    .checkbox-group h4 {
      font-size: 1em;
      margin-bottom: 8px;
    }
    /* Nouveau groupe pour les curseurs de versement */
    .range-group {
      border: 1px solid #ccc;
      padding: 8px;
      border-radius: 6px;
      background: #f0f4f8;
      width: 100%;
    }
    .range-group h4 {
      font-size: 1em;
      margin-bottom: 8px;
    }
    /* Tableau principal avec alternance de couleur */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table thead {
      background-color: #f0f4f8;
    }
    table th, table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    table tbody tr:hover {
      background-color: #f9fafb;
    }
    /* Boutons d'action */
    .btn-performance {
      background-color: #4a90e2;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s ease;
    }
    .btn-performance:hover {
      background-color: #357ab8;
    }
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: center;
      }
      table th, table td {
        padding: 10px;
      }
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      padding: 20px;
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 8px;
      width: 95%;
      max-width: 900px;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5em;
      cursor: pointer;
      color: #888;
    }
    .profile-section {
      margin-bottom: 40px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 20px;
    }
    .profile-section:last-child {
      border-bottom: none;
    }
    .charts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .charts canvas {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 10px;
    }
    /* Tableau de performances */
    .perf-table {
      border-collapse: collapse;
      width: 100%;
      max-width: 400px;
      margin: 10px 0;
    }
    .perf-table th,
    .perf-table td {
      border: 1px solid #e2e8f0;
      padding: 6px 8px;
      text-align: center;
      font-size: 0.9em;
    }
    .perf-table th {
      background-color: #f0f4f8;
    }
    /* Encart pour supports d'investissement */
    .investment-supports {
      margin-top: 10px;
      text-align: left;
    }
    .investment-supports h4 {
      margin-bottom: 5px;
      font-size: 1em;
      color: #357ab8;
    }
    .investment-supports p {
      margin: 2px 0;
      font-size: 0.9em;
    }
    /* Ligne supplémentaire pour la section extra */
    .extra-info {
      background-color: #f9fafb;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">Comparateur d'Assurance Vie</div>
  <!-- Sous-header -->
  <div class="sub-header">
    <p>&copy; Baptiste Plat Garnier</p>
  </div>
  <div class="container">
    <!-- Zone des filtres -->
    <div class="filters">
      <div>
        <label for="assureur">Assureur :</label>
        <select id="assureur">
          <option value="">Tous</option>
        </select>
      </div>
      <div>
        <label for="distributeur">Distributeur :</label>
        <select id="distributeur">
          <option value="">Tous</option>
        </select>
      </div>
      <div>
        <label for="nom">Nom du contrat :</label>
        <input type="text" id="nom" placeholder="Rechercher un contrat">
      </div>
      <!-- Groupe pour les options de versement -->
      <div class="range-group">
        <h4>Options de versement</h4>
        <div>
          <label for="versement">Versement initial (max) :</label>
          <input type="range" id="versement" value="50" min="0" max="5000" step="50">
          <input type="number" id="versement_number" value="50" min="0" max="5000" step="50"> €
        </div>
        <div>
          <label for="versement_libre">Versement libre min. :</label>
          <input type="range" id="versement_libre" value="50" min="0" max="5000" step="50">
          <input type="number" id="versement_libre_number" value="50" min="0" max="5000" step="50"> €
        </div>
        <div>
          <label for="versement_mensuel">Versement mensuel prog min. :</label>
          <input type="range" id="versement_mensuel" value="50" min="0" max="5000" step="50">
          <input type="number" id="versement_mensuel_number" value="50" min="0" max="5000" step="50"> €
        </div>
        <div>
          <label for="versement_trimestriel">Versement trimestriel prog min. :</label>
          <input type="range" id="versement_trimestriel" value="50" min="0" max="5000" step="50">
          <input type="number" id="versement_trimestriel_number" value="50" min="0" max="5000" step="50"> €
        </div>
        <div>
          <label for="versement_semestre">Versement semestre prog min. :</label>
          <input type="range" id="versement_semestre" value="50" min="0" max="5000" step="50">
          <input type="number" id="versement_semestre_number" value="50" min="0" max="5000" step="50"> €
        </div>
        <div>
          <label for="versement_annuel">Versement annuel prog min. :</label>
          <input type="range" id="versement_annuel" value="50" min="0" max="5000" step="50">
          <input type="number" id="versement_annuel_number" value="50" min="0" max="5000" step="50"> €
        </div>
      </div>
      <!-- Checkboxes indépendantes -->
      <div>
        <input type="checkbox" id="gestion" class="checkbox-filter" data-column="Gestion pilotée" data-value="Gestion pilotée">
        <label for="gestion">Gestion pilotée</label>
        <span class="info-icon" data-tooltip="Ce contrat offre une gestion pilotée par des experts.">ℹ</span>
      </div>
      <div>
        <input type="checkbox" id="versements_programmes" class="checkbox-filter" data-column="Versements programmés" data-value="Versements programmés">
        <label for="versements_programmes">Versements programmés</label>
        <span class="info-icon" data-tooltip="Ce contrat permet des versements programmés réguliers.">ℹ</span>
      </div>
      <!-- Regroupement des options financières en gestion libre -->
      <div class="checkbox-group">
        <h4>Options financières en gestion libre</h4>
        <div>
          <input type="checkbox" id="securisation" class="checkbox-filter" data-column="Sécurisation des plus-values" data-value="Sécurisation des plus-values">
          <label for="securisation">Sécurisation des plus-values</label>
          <span class="info-icon" data-tooltip="Ce contrat offre une sécurisation optimisée de vos plus-values.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="dynamisation" class="checkbox-filter" data-column="Dynamisation des plus-values" data-value="Dynamisation des plus-values">
          <label for="dynamisation">Dynamisation des plus-values</label>
          <span class="info-icon" data-tooltip="Ce contrat permet une dynamisation active de vos plus-values.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="investissement" class="checkbox-filter" data-column="Investissement progressif" data-value="Investissement progressif">
          <label for="investissement">Investissement progressif</label>
          <span class="info-icon" data-tooltip="Ce contrat propose un investissement progressif adapté.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="stoploss" class="checkbox-filter" data-column="Stop/Loss" data-value="Stop/Loss">
          <label for="stoploss">Stop/Loss</label>
          <span class="info-icon" data-tooltip="Ce contrat inclut un mécanisme de stop/loss pour limiter les pertes.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="reequilibrage" class="checkbox-filter" data-column="Réequilibrage auitomatique" data-value="Réequilibrage auitomatique">
          <label for="reequilibrage">Réequilibrage auitomatique</label>
          <span class="info-icon" data-tooltip="Ce contrat offre un rééquilibrage automatique de votre portefeuille.">ℹ</span>
        </div>
      </div>
      <!-- Nouvelle checkbox "Multipoches" (hors groupe) -->
      <div>
        <input type="checkbox" id="multipoches" class="checkbox-filter" data-column="Multipoches" data-value="Multipoches">
        <label for="multipoches">Multipoches</label>
        <span class="info-icon" data-tooltip="Ce contrat propose l'option Multipoches.">ℹ</span>
      </div>
      <!-- Nouveau groupe "Supports d'investissement" -->
      <div class="checkbox-group">
        <h4>Supports d'investissement</h4>
        <div>
          <input type="checkbox" id="etf" class="checkbox-filter" data-column="ETF" data-value="ETF">
          <label for="etf">ETF</label>
          <span class="info-icon" data-tooltip="Support d'investissement : ETF.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="titres_vifs" class="checkbox-filter" data-column="Titres Vifs" data-value="Titres Vifs">
          <label for="titres_vifs">Titres Vifs</label>
          <span class="info-icon" data-tooltip="Support d'investissement : Titres Vifs.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="fcpr" class="checkbox-filter" data-column="FCPR" data-value="FCPR">
          <label for="fcpr">FCPR</label>
          <span class="info-icon" data-tooltip="Support d'investissement : FCPR.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="scpi" class="checkbox-filter" data-column="SCPI" data-value="SCPI">
          <label for="scpi">SCPI</label>
          <span class="info-icon" data-tooltip="Support d'investissement : SCPI.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="opci" class="checkbox-filter" data-column="OPCI" data-value="OPCI">
          <label for="opci">OPCI</label>
          <span class="info-icon" data-tooltip="Support d'investissement : OPCI.">ℹ</span>
        </div>
        <div>
          <input type="checkbox" id="sci" class="checkbox-filter" data-column="SCI" data-value="SCI">
          <label for="sci">SCI</label>
          <span class="info-icon" data-tooltip="Support d'investissement : SCI.">ℹ</span>
        </div>
      </div>
    </div>

    <!-- Tableau principal -->
    <table id="contrats">
      <thead>
        <tr>
          <!-- La première colonne intègre la flèche toggle à gauche du nom du contrat -->
          <th data-key="nom">Nom du contrat</th>
          <th data-key="assureur">Assureur</th>
          <th data-key="distributeur">Distributeur</th>
          <th data-key="versement">Versement initial</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Les données se chargeront ici -->
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p>&copy; Baptiste Plat Garnier</p>
  </footer>

  <!-- Modal de performance -->
  <div id="performanceModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" id="modalClose">&times;</span>
      <h2 id="modalTitle">Performances de la gestion pilotée</h2>
      <div id="profileChartsContainer"></div>
    </div>
  </div>

  <!-- Inclusion de PapaParse et Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Fonction pour construire les trois tableaux financiers décomposés
    function buildFinancialTables(item) {
      // Frais fixes
      let tableFraisFixes = `<h4>Frais fixes</h4>
        <table class="perf-table">
          <thead>
            <tr>
              <th>Frais de dossier</th>
              <th>Droits d'entrée</th>
              <th>Frais de rachat</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${item["Frais de dossier"] || "-"}</td>
              <td>${item["Droits d'entrée"] || "-"}</td>
              <td>${item["Frais de rachat"] || "-"}</td>
            </tr>
          </tbody>
        </table>`;
      // Frais récurrents
      let tableFraisRecurrents = `<h4>Frais récurrents</h4>
        <table class="perf-table">
          <thead>
            <tr>
              <th>FV€</th>
              <th>FVUC</th>
              <th>FVGSM</th>
              <th>Arbitrages gratuits/an</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${item["FV€"] || "-"}</td>
              <td>${item["FVUC"] || "-"}</td>
              <td>${item["FVGSM"] || "-"}</td>
              <td>${item["Arbitrages gratuits/an"] || "-"}</td>
            </tr>
          </tbody>
        </table>`;
      // Frais de gestion avec intégration de la colonne "frais add. GP"
      let tableFraisGestion = `<h4>Frais de gestion</h4>
        <table class="perf-table">
          <thead>
            <tr>
              <th>Fonds en euro classique</th>
              <th>Frais de gestion UC</th>
              <th>Frais add. GP</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${item["Fonds en euro classique"] || "-"}</td>
              <td>${item["Frais de gestion UC"] || "-"}</td>
              <td>${item["frais add. GP"] || "-"}</td>
            </tr>
          </tbody>
        </table>`;
      return tableFraisFixes + tableFraisRecurrents + tableFraisGestion;
    }

    // Fonction pour afficher le tableau principal avec flèche toggle intégrée et alternance de couleur
    function afficherDonnees(donnees) {
      const tbody = document.querySelector("#contrats tbody");
      tbody.innerHTML = "";
      donnees.forEach((item, index) => {
        // Création de la ligne principale
        const tr = document.createElement("tr");
        tr.style.backgroundColor = (index % 2 === 0) ? "#fff" : "#EFEFEF";

        // Colonne "Nom du contrat" avec bouton toggle
        const tdNom = document.createElement("td");
        const toggleBtn = document.createElement("button");
        toggleBtn.className = "toggle-arrow";
        toggleBtn.textContent = "▼";
        toggleBtn.addEventListener("click", function() {
          toggleExtra(index, this);
        });
        tdNom.appendChild(toggleBtn);
        tdNom.insertAdjacentText("beforeend", " " + item.nom);
        tr.appendChild(tdNom);

        // Colonne Assureur
        const tdAssureur = document.createElement("td");
        tdAssureur.textContent = item.assureur;
        tr.appendChild(tdAssureur);

        // Colonne Distributeur
        const tdDistributeur = document.createElement("td");
        tdDistributeur.textContent = item.distributeur;
        tr.appendChild(tdDistributeur);

        // Colonne Versement initial
        const tdVersement = document.createElement("td");
        tdVersement.textContent = item.versement;
        tr.appendChild(tdVersement);

        // Colonne Actions
        const tdActions = document.createElement("td");
        if (item["Gestion pilotée"] && item["Gestion pilotée"].toLowerCase().trim() === "gestion pilotée") {
          const btnPerformance = document.createElement("button");
          btnPerformance.className = "btn-performance";
          btnPerformance.textContent = "Accéder aux performances";
          btnPerformance.addEventListener("click", function() {
            viewPerformance(item);
          });
          tdActions.appendChild(btnPerformance);
        }
        tr.appendChild(tdActions);

        tbody.appendChild(tr);

        // Ligne supplémentaire dépliable pour afficher les informations complémentaires
        const extraRow = document.createElement("tr");
        extraRow.id = "extra_" + index;
        extraRow.className = "extra-info";
        extraRow.style.display = "none";
        const tdExtra = document.createElement("td");
        tdExtra.colSpan = 5;
        tdExtra.innerHTML = `
          <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
              <p><strong>Année de lancement :</strong> ${item.annee}</p>
              <p><strong>Nature du contrat :</strong> ${item.nature}</p>
              <p><strong>Encours min. en gestion pilotée :</strong> ${item.ticket}</p>
              <p><strong>Architecture :</strong> ${item.architecture}</p>
              <h4>Supports d'investissement en gestion libre</h4>
              <p><strong>ETF :</strong> ${item["ETF"] || "-"}</p>
              <p><strong>Titres vifs :</strong> ${item["Titres vifs"] || "-"}</p>
              <p><strong>FCPR :</strong> ${item["FCPR"] || "-"}</p>
              <p><strong>OPCI :</strong> ${item["OPCI"] || "-"}</p>
              <p><strong>SCPI :</strong> ${item["SCPI"] || "-"}</p>
              <p><strong>SCI :</strong> ${item["SCI"] || "-"}</p>
            </div>
            <div style="flex: 1;">
              ${buildFinancialTables(item)}
            </div>
          </div>
          <div class="extra-content">Informations supplémentaires à venir.</div>
        `;
        extraRow.appendChild(tdExtra);
        tbody.appendChild(extraRow);
      });
    }

    // Fonction de bascule pour la ligne supplémentaire et changement de l'icône de la flèche
    function toggleExtra(index, btn) {
      const extraRow = document.getElementById("extra_" + index);
      if (extraRow.style.display === "none" || extraRow.style.display === "") {
        extraRow.style.display = "table-row";
        btn.textContent = "▲";
      } else {
        extraRow.style.display = "none";
        btn.textContent = "▼";
      }
    }

    // Remplissage des menus déroulants
    function remplirFiltreAssureur(donnees) {
      const select = document.getElementById("assureur");
      const assureurs = [...new Set(donnees.map(item => item.assureur))];
      assureurs.forEach(assureur => {
        const option = document.createElement("option");
        option.value = assureur;
        option.textContent = assureur;
        select.appendChild(option);
      });
    }
    function remplirFiltreDistributeur(donnees) {
      const select = document.getElementById("distributeur");
      const distributeurs = [...new Set(donnees.map(item => item.distributeur))];
      distributeurs.forEach(distributeur => {
        const option = document.createElement("option");
        option.value = distributeur;
        option.textContent = distributeur;
        select.appendChild(option);
      });
    }

    // Fonction de filtrage combiné, avec prise en compte des valeurs des curseurs
    function filtrerDonnees(donnees) {
      const filtreAssureur = document.getElementById("assureur").value;
      const filtreDistributeur = document.getElementById("distributeur").value;
      const filtreNom = document.getElementById("nom").value.toLowerCase();

      const maxVersement = parseFloat(document.getElementById("versement").value);
      const maxVersementLibre = parseFloat(document.getElementById("versement_libre").value);
      const maxVersementMensuel = parseFloat(document.getElementById("versement_mensuel").value);
      const maxVersementTrimestriel = parseFloat(document.getElementById("versement_trimestriel").value);
      const maxVersementSemestre = parseFloat(document.getElementById("versement_semestre").value);
      const maxVersementAnnuel = parseFloat(document.getElementById("versement_annuel").value);

      const checkboxes = document.querySelectorAll(".checkbox-filter");

      const donneesFiltrees = donnees.filter(item => {
        // Versement initial
        let versementInitial = parseFloat(item.versement.replace(/[^\d.]/g, '')) || 0;
        // Nouveaux versements (les colonnes doivent être exactement nommées comme dans le sheet)
        let versementLibre = parseFloat((item["Versement libre min."] || "0").replace(/[^\d.]/g, '')) || 0;
        let versementMensuel = parseFloat((item["Versement mensuel prog min."] || "0").replace(/[^\d.]/g, '')) || 0;
        let versementTrimestriel = parseFloat((item["Versement trimestriel prog min."] || "0").replace(/[^\d.]/g, '')) || 0;
        let versementSemestre = parseFloat((item["Versement semestre prog min."] || "0").replace(/[^\d.]/g, '')) || 0;
        let versementAnnuel = parseFloat((item["Versement annuel prog min."] || "0").replace(/[^\d.]/g, '')) || 0;

        let conditionsCheckbox = true;
        checkboxes.forEach(checkbox => {
          if (checkbox.checked) {
            const col = checkbox.dataset.column;
            const val = checkbox.dataset.value;
            conditionsCheckbox = conditionsCheckbox &&
              (item[col] && item[col].toLowerCase().trim() === val.toLowerCase().trim());
          }
        });
        return (
          (filtreAssureur === "" || item.assureur === filtreAssureur) &&
          (filtreDistributeur === "" || item.distributeur === filtreDistributeur) &&
          (filtreNom === "" || item.nom.toLowerCase().includes(filtreNom)) &&
          (isNaN(maxVersement) || versementInitial <= maxVersement) &&
          (isNaN(maxVersementLibre) || versementLibre <= maxVersementLibre) &&
          (isNaN(maxVersementMensuel) || versementMensuel <= maxVersementMensuel) &&
          (isNaN(maxVersementTrimestriel) || versementTrimestriel <= maxVersementTrimestriel) &&
          (isNaN(maxVersementSemestre) || versementSemestre <= maxVersementSemestre) &&
          (isNaN(maxVersementAnnuel) || versementAnnuel <= maxVersementAnnuel) &&
          conditionsCheckbox
        );
      });
      afficherDonnees(donneesFiltrees);
    }

    // Fonction pour ouvrir le modal et afficher les performances pour chaque profil (données du second onglet)
    function viewPerformance(contract) {
      const modal = document.getElementById("performanceModal");
      modal.style.display = "block";
      document.getElementById("modalTitle").textContent = `Performances de ${contract.nom}`;

      const chartsContainer = document.getElementById("profileChartsContainer");
      chartsContainer.innerHTML = "";

      // URL du second onglet contenant les données de performance
      const performanceCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTN6FYOsXyedk2KNxaqBAUz4ctA_fUPeT7dr3Ki4-uks2FUg2D9TqseBYT9u05sA_LCbR47rJbkNWGI/pub?gid=1183800682&single=true&output=csv';

      Papa.parse(performanceCsvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          const perfData = results.data;
          const contractPerfRows = perfData.filter(row => row["Nom du contrat"] === contract.nom);

          if (contractPerfRows.length === 0) {
            chartsContainer.innerHTML = "<p>Aucune donnée de performance trouvée pour ce contrat.</p>";
            return;
          }

          contractPerfRows.forEach((profileRow, index) => {
            const profileDiv = document.createElement("div");
            profileDiv.className = "profile-section";
            profileDiv.innerHTML = `<h3>Profil : ${profileRow["Profil"] || "Non défini"} - Gestionnaire : ${profileRow["Gestionnaire d'actif"] || "Non défini"}</h3>`;
            
            // Conteneur flex pour disposer le tableau et le graphique côte à côte
            const containerDiv = document.createElement("div");
            containerDiv.style.display = "flex";
            containerDiv.style.gap = "20px";
            
            // Div pour le tableau des performances
            const tableDiv = document.createElement("div");
            tableDiv.style.flex = "1";
            const yearsArray = ["2024", "2023", "2022", "2021", "2020", "2019", "2020", "2018", "2017", "2016"];
            let tableHTML = `<table class="perf-table"><thead><tr><th>Année</th><th>Performance (%)</th></tr></thead><tbody>`;
            yearsArray.forEach(year => {
              const perfValue = (profileRow[year] !== undefined && profileRow[year] !== "") ? profileRow[year] : "-";
              tableHTML += `<tr><td>${year}</td><td>${perfValue}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            tableDiv.innerHTML = tableHTML;
            
            // Div pour le graphique (pie chart)
            const chartDiv = document.createElement("div");
            chartDiv.style.flex = "1";
            const pieCanvas = document.createElement("canvas");
            pieCanvas.id = `pieChart_${index}`;
            pieCanvas.width = 200;
            pieCanvas.height = 200;
            chartDiv.appendChild(pieCanvas);
            
            // Ajout des deux colonnes dans le conteneur flex
            containerDiv.appendChild(tableDiv);
            containerDiv.appendChild(chartDiv);
            
            // Ajout du conteneur flex à la section profil
            profileDiv.appendChild(containerDiv);
            chartsContainer.appendChild(profileDiv);
            
            // Initialisation du graphique (pie chart)
            const partUC = profileRow.part_uc ? parseFloat(profileRow.part_uc) : 50;
            const partFonds = profileRow.part_fonds ? parseFloat(profileRow.part_fonds) : (100 - partUC);
            new Chart(pieCanvas.getContext("2d"), {
              type: 'pie',
              data: {
                labels: ['UC', 'Fonds en euros'],
                datasets: [{
                  data: [partUC, partFonds],
                  backgroundColor: ['#36A2EB', '#FFCE56']
                }]
              },
              options: { responsive: true }
            });
          });
        },
        error: function(err) {
          console.error("Erreur lors du chargement du CSV de performance :", err);
        }
      });
    }

    // Fermeture du modal
    document.getElementById("modalClose").addEventListener("click", function() {
      document.getElementById("performanceModal").style.display = "none";
    });
    window.addEventListener("click", function(event) {
      const modal = document.getElementById("performanceModal");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    });

    // Initialisation du comparateur principal
    function init() {
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTN6FYOsXyedk2KNxaqBAUz4ctA_fUPeT7dr3Ki4-uks2FUg2D9TqseBYT9u05sA_LCbR47rJbkNWGI/pub?output=csv';
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results) {
          const data = results.data;
          console.log("Données chargées :", data);
          afficherDonnees(data);
          remplirFiltreAssureur(data);
          remplirFiltreDistributeur(data);

          // Configuration des curseurs de versement (min=0, max=5000, step=50, valeur par défaut = 50)
          const sliderIds = [
            "versement", "versement_libre", "versement_mensuel",
            "versement_trimestriel", "versement_semestre", "versement_annuel"
          ];
          sliderIds.forEach(id => {
            const slider = document.getElementById(id);
            slider.min = 0;
            slider.max = 5000;
            slider.step = 50;
            slider.value = 50;
            const numberInput = document.getElementById(id + "_number");
            if(numberInput){
              numberInput.min = 0;
              numberInput.max = 5000;
              numberInput.step = 50;
              numberInput.value = 50;
              slider.addEventListener("input", function() {
                numberInput.value = this.value;
                filtrerDonnees(data);
              });
              numberInput.addEventListener("input", function() {
                slider.value = this.value;
                filtrerDonnees(data);
              });
            } else {
              slider.addEventListener("input", function() {
                filtrerDonnees(data);
              });
            }
          });

          // Écouteurs d'événements pour les autres filtres
          document.getElementById("assureur").addEventListener("change", () => filtrerDonnees(data));
          document.getElementById("distributeur").addEventListener("change", () => filtrerDonnees(data));
          document.getElementById("nom").addEventListener("input", () => filtrerDonnees(data));
          const checkboxFilters = document.querySelectorAll(".checkbox-filter");
          checkboxFilters.forEach(checkbox => {
            checkbox.addEventListener("change", () => filtrerDonnees(data));
          });
        },
        error: function(err) {
          console.error("Erreur lors du chargement du CSV :", err);
        }
      });
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
